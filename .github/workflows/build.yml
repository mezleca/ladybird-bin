name: build ladybird

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      no_cache:
        type: boolean
        default: false
        description: disable cache
      clean_build:
        type: boolean
        default: false
        description: clean build directory before building

env:
  BUILD_TYPE: Release
  CCACHE_DIR: ${{ github.workspace }}/.ccache
  VCPKG_DEFAULT_BINARY_CACHE: ${{ github.workspace }}/.vcpkg-binary-cache

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: checkout repository
      uses: actions/checkout@v5
      with:
        submodules: false
        fetch-depth: 1

    - name: get current date
      id: date
      run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

    - name: setup cache directories
      run: |
        mkdir -p ${{ env.CCACHE_DIR }}
        mkdir -p ${{ env.VCPKG_DEFAULT_BINARY_CACHE }}

    - name: install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          autoconf autoconf-archive automake build-essential ccache cmake \
          curl fonts-liberation2 git libdrm-dev libgl1-mesa-dev libtool \
          nasm ninja-build pkg-config python3-venv qt6-base-dev \
          libqt6widgets6 qt6-tools-dev-tools qt6-wayland-dev tar unzip zip libpulse-dev libxcb-xinput-dev libxkbcommon-dev

    - name: install cmake 3.30+
      run: |
        wget -O - https://apt.kitware.com/keys/kitware-archive-latest.asc 2>/dev/null | gpg --dearmor - | sudo tee /usr/share/keyrings/kitware-archive-keyring.gpg >/dev/null
        echo "deb [signed-by=/usr/share/keyrings/kitware-archive-keyring.gpg] https://apt.kitware.com/ubuntu/ $(lsb_release -sc) main" | sudo tee /etc/apt/sources.list.d/kitware.list
        sudo apt-get update
        sudo apt-get install -y cmake

    - name: install clang-20
      run: |
        sudo wget -O /usr/share/keyrings/llvm-snapshot.gpg.key https://apt.llvm.org/llvm-snapshot.gpg.key
        echo "deb [signed-by=/usr/share/keyrings/llvm-snapshot.gpg.key] https://apt.llvm.org/$(lsb_release -sc)/ llvm-toolchain-$(lsb_release -sc)-20 main" | sudo tee -a /etc/apt/sources.list.d/llvm.list
        sudo apt-get update
        sudo apt-get install -y clang-20 clangd-20 clang-tools-20 lld-20

    - name: setup ladybird source
      run: python3 ladybird.py setup

    - name: restore ccache
      if: ${{ !inputs.no_cache }}
      uses: actions/cache@v4
      with:
        path: ${{ env.CCACHE_DIR }}
        key: ccache-${{ runner.os }}-clang20-${{ github.sha }}
        restore-keys: |
          ccache-${{ runner.os }}-clang20-

    - name: restore vcpkg cache
      id: vcpkg-cache
      if: ${{ !inputs.no_cache }}
      uses: actions/cache@v4
      with:
        path: |
          ladybird/Build/vcpkg
          ladybird/Build/release/vcpkg_installed
          ${{ env.VCPKG_DEFAULT_BINARY_CACHE }}
        key: vcpkg-${{ runner.os }}-clang20-${{ hashFiles('ladybird/vcpkg.json', 'ladybird/vcpkg-configuration.json') }}
        restore-keys: |
          vcpkg-${{ runner.os }}-clang20-

    - name: configure ccache
      run: |
        ccache --set-config=max_size=5G
        ccache --set-config=compression=true
        ccache --set-config=compression_level=6
        ccache -z

    - name: build ladybird
      env:
        CC: clang-20
        CXX: clang++-20
      run: |
        BUILD_FLAGS=""
        if [ "${{ inputs.clean_build }}" = "true" ]; then
          BUILD_FLAGS="--clean"
        fi
        python3 ladybird.py build $BUILD_FLAGS

    - name: package ladybird (appimage)
      run: python3 ladybird.py package --type appimage --name Ladybird-${{ steps.date.outputs.date }}

    - name: package ladybird (tarball)
      run: python3 ladybird.py package --type tarball --name Ladybird-${{ steps.date.outputs.date }}

    - name: show ccache stats
      if: always()
      run: ccache -s

    - name: save ccache
      if: ${{ !inputs.no_cache && always() }}
      uses: actions/cache@v4
      with:
        path: ${{ env.CCACHE_DIR }}
        key: ccache-${{ runner.os }}-clang20

    - name: upload artifact
      uses: actions/upload-artifact@v6
      with:
        name: ladybird-linux-x64-${{ steps.date.outputs.date }}
        path: |
            "output/*.AppImage"
            "output/*.tar.gz"
        retention-days: 30

    - name: create release
      if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: nightly-${{ steps.date.outputs.date }}
        name: Nightly Build ${{ steps.date.outputs.date }}
        body: |
          ladybird ${{ steps.date.outputs.date }} build
        files: output/Ladybird-x86_64-${{ steps.date.outputs.date }}.AppImage
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
