name: export cache

on:
  workflow_dispatch:
    inputs:
      cache_key:
        description: 'cache key to export (e.g., ccache-Linux-123)'
        required: true
        type: string
      cache_type:
        description: 'cache type'
        required: true
        type: choice
        options:
          - ccache
          - vcpkg
          - vcpkg-repo

env:
  CCACHE_DIR: ${{ github.workspace }}/.ccache
  VCPKG_DEFAULT_BINARY_CACHE: ${{ github.workspace }}/.vcpkg-cache

jobs:
  export:
    runs-on: ubuntu-latest

    steps:
    - name: setup cache directory
      run: |
        case "${{ inputs.cache_type }}" in
          ccache)
            mkdir -p ${{ env.CCACHE_DIR }}
            echo "CACHE_PATH=${{ env.CCACHE_DIR }}" >> $GITHUB_ENV
            ;;
          vcpkg)
            mkdir -p ${{ env.VCPKG_DEFAULT_BINARY_CACHE }}
            echo "CACHE_PATH=${{ env.VCPKG_DEFAULT_BINARY_CACHE }}" >> $GITHUB_ENV
            ;;
          vcpkg-repo)
            mkdir -p ladybird/Build/vcpkg
            echo "CACHE_PATH=ladybird/Build/vcpkg" >> $GITHUB_ENV
            ;;
        esac

    - name: restore cache
      uses: actions/cache/restore@v4
      with:
        path: ${{ env.CACHE_PATH }}
        key: ${{ inputs.cache_key }}
        fail-on-cache-miss: true

    - name: create cache archive
      run: |
        tar -czf ${{ github.workspace }}/cache-export.tar.gz -C $(dirname ${{ env.CACHE_PATH }}) $(basename ${{ env.CACHE_PATH }})

    - name: get cache size
      run: |
        SIZE=$(du -sh ${{ env.CACHE_PATH }} | cut -f1)
        echo "cache size: $SIZE"

    - name: upload cache as artifact
      uses: actions/upload-artifact@v4
      with:
        name: cache-${{ inputs.cache_type }}-${{ github.run_number }}
        path: cache-export.tar.gz
        retention-days: 7